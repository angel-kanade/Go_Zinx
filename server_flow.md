# Go_Zinx服务器完整流程说明

## 一、服务器启动流程

### 1. 配置加载
- **加载配置文件**：从`resource/config.json`加载服务器配置（端口、最大连接数等）
- **初始化全局对象**：`utils.GlobalObj`存储配置信息，供各模块使用

### 2. 组件初始化
- **创建Server实例**：初始化服务器基本信息（名称、IP、端口等）
- **初始化消息路由器**：创建`MsgRouter`实例，用于消息分发
- **初始化连接管理器**：创建`ConnManager`实例，管理所有客户端连接
- **初始化心跳检测器**：创建`HeartbeatChecker`实例，定期检查连接状态
- **初始化工作池**：创建`WorkerPool`实例，根据配置创建核心工作线程

### 3. 启动服务
- **注册消息处理器**：根据业务需求注册消息ID对应的处理器
- **启动工作池**：启动工作线程和任务调度器
- **启动心跳检测**：使用`time.Ticker`定期检查连接活跃度（默认5秒）
- **创建TCP监听器**：在指定IP和端口创建TCP监听器
- **启动性能监控**：定期输出性能报告
- **进入主循环**：阻塞等待客户端连接

## 二、客户端连接与使用流程

### 1. 连接建立
- **客户端发起连接**：客户端通过TCP连接到服务器指定端口
- **服务器接受连接**：调用`listener.AcceptTCP()`接受客户端连接
- **创建Connection实例**：为每个连接创建唯一的`Connection`对象
- **分配连接ID**：使用原子操作`atomic.AddUint32`确保并发安全
- **加入连接管理器**：将新连接添加到`ConnManager`中管理
- **启动读写协程**：为每个连接启动独立的读协程和写协程
- **调用OnConnStart钩子**：执行连接建立时的自定义逻辑

### 2. 消息发送与接收
- **客户端发送消息**：按照自定义二进制协议打包消息并发送
- **服务器接收消息**：读协程从TCP连接读取数据
- **消息解析**：使用`DataPack`解析二进制数据，获取消息ID和内容
- **构造Request对象**：封装连接、消息ID和内容为`Request`对象
- **消息路由**：根据消息ID查找对应的处理器
- **任务调度**：将请求发送到工作池处理

### 3. 消息处理
- **工作线程处理**：工作池中的线程从任务队列获取请求
- **调用处理器**：依次执行处理器的`PreHandle`、`Handle`、`PostHandle`方法
- **发送响应**：处理完成后，通过`MsgChan`发送响应给客户端

### 4. 心跳维持
- **客户端发送心跳**：定期发送消息ID为0的心跳包
- **服务器更新活动时间**：接收到心跳包后更新连接的最后活动时间
- **心跳检测**：心跳检测器定期检查所有连接，关闭超时未活动的连接

## 三、服务器关闭流程

### 1. 关闭信号处理
- **接收到关闭信号**：如Ctrl+C或其他终止信号
- **停止接收新连接**：关闭TCP监听器，停止接受新的客户端连接

### 2. 连接清理
- **关闭现有连接**：遍历连接管理器中的所有连接，依次关闭
- **调用OnConnStop钩子**：执行连接关闭时的自定义逻辑
- **更新性能指标**：统计已关闭的连接数

### 3. 组件停止
- **停止心跳检测**：关闭心跳检测的`ticker`和协程
- **停止工作池**：停止所有工作线程，等待正在处理的任务完成
- **释放资源**：关闭所有通道和锁，释放占用的系统资源

### 4. 退出程序
- **输出最终日志**：记录服务器关闭信息
- **程序退出**：返回退出码0表示正常关闭

## 四、关键技术点

1. **并发安全**：使用互斥锁（`sync.RWMutex`）保护共享资源，原子操作确保计数器并发安全
2. **协程管理**：使用Go协程实现高并发，通过通道（`chan`）协调协程间通信
3. **资源管理**：工作池动态调整线程数，心跳检测自动清理空闲连接
4. **错误处理**：完善的错误日志记录，确保程序稳定性
5. **性能优化**：任务队列缓冲、读写分离、非阻塞IO等技术提高性能

## 五、典型交互示例

```
客户端 → [TCP连接] → 服务器
客户端 → [发送消息] → 服务器 → [解析消息] → [任务调度] → [处理消息] → [发送响应] → 客户端
客户端 → [定期心跳] → 服务器 → [更新活动时间]
服务器 → [心跳检测] → [关闭超时连接]
```

这个流程确保了服务器的高可用性、高性能和良好的资源管理，能够满足各种网络应用的需求。